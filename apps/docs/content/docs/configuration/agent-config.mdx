---
title: Agent config
description: Workspaces, skills, and per‑gateway profiles.
---

This page explains the per‑gateway configuration surface (gateway instances):
workspaces, skills, and how profiles map into the Nix layer.

There are three sources of truth you will touch most often when you configure agents:

- `fleet/clawlets.json` (canonical fleet + host config)
- `fleet/bundled-skills.json` (canonical allowlist for Nix assertions + doctor)
- `fleet/workspaces/**` (prompt/policy docs + skills)

At deploy time, the Nix layer renders a per‑gateway OpenClaw config file so services
consume a single, validated JSON file:

- Nix generates `/run/secrets/rendered/openclaw-<id>.json`

## Canonical gateway config (typed surfaces + OpenClaw schema)

For the full picture (merge order + how Nix renders), see
[Typed config surfaces](/configuration/typed-surfaces).

Each gateway has a single input object with typed surfaces plus a raw OpenClaw passthrough:

- `hosts.<host>.gateways.<gatewayId>.channels`
- `hosts.<host>.gateways.<gatewayId>.agents`
- `hosts.<host>.gateways.<gatewayId>.hooks`
- `hosts.<host>.gateways.<gatewayId>.skills`
- `hosts.<host>.gateways.<gatewayId>.plugins`
- `hosts.<host>.gateways.<gatewayId>.openclaw` (JSON passthrough for advanced config)

Clawlets invariants override (gateway mode/bind/port/auth; workspace + skipBootstrap).

### Example: Discord token via secret

```json
{
  "hosts": {
    "openclaw-fleet-host": {
      "gatewaysOrder": ["maren"],
      "gateways": {
        "maren": {
          "profile": {
            "secretEnv": {
              "DISCORD_BOT_TOKEN": "discord_token_maren"
            }
          },
          "channels": {
            "discord": {
              "enabled": true,
              "token": "${DISCORD_BOT_TOKEN}"
            }
          }
        }
      }
    }
  }
}
```

## Gateway isolation (multi‑gateway)

Each gateway runs in its own process and Unix user so logs, state, and credentials are
isolated. This keeps failures contained and makes auditing easier.

Per gateway:

- system user: `gateway-<id>`
- state dir: `/srv/openclaw/<id>`
- workspace: `/srv/openclaw/<id>/workspace` (default)
- gateway config: `/run/secrets/rendered/openclaw-<id>.json`
- gateway auth token env: `/srv/openclaw/<id>/credentials/gateway.env`

Ports:

- base: `18789`
- stride: `120` (derived ports won't collide)

## Secrets

Secrets are wired with a provider-agnostic mapping. Global defaults live at the fleet
level and can be overridden per gateway:

- global defaults: `fleet.secretEnv.<ENV_VAR> = "<secretName>"`
- per‑gateway overrides: `hosts.<host>.gateways.<gatewayId>.profile.secretEnv.<ENV_VAR> = "<secretName>"`

Examples:

- Discord: `DISCORD_BOT_TOKEN → discord_token_<gatewayId>`
- Telegram: `TELEGRAM_BOT_TOKEN → telegram_bot_token_<gatewayId>`
- Slack: `SLACK_BOT_TOKEN → slack_bot_token_<gatewayId>`, `SLACK_APP_TOKEN → slack_app_token_<gatewayId>`
- Models: `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `ZAI_API_KEY`

## Documents (AGENTS / SOUL / TOOLS / IDENTITY)

Workspace docs (prompt and policy) are split into shared and per-gateway overlays:

- `fleet/workspaces/common/` (shared)
- `fleet/workspaces/gateways/<gatewayId>/` (overrides; overlay on top of common)

Fleet config points Nix at the workspace seed root:

```nix
documentsDir = ./fleet/workspaces;
```

Anything under `documentsDir` is copied into the Nix store. Treat it as public and do
not place secrets in `fleet/workspaces/**`.

On every gateway service start:

- if workspace empty: seed common then gateway overlay
- always: sync a managed allowlist (AGENTS/SOUL/IDENTITY/TOOLS/USER/HEARTBEAT)
- always: sync `skills/` into the workspace (custom/local skills)

### Custom/local skills

Put skill definitions under shared or per-gateway workspaces so they are discoverable by
the runtime without extra config:

- shared: `fleet/workspaces/common/skills/<skill>/SKILL.md`
- per‑gateway: `fleet/workspaces/gateways/<gatewayId>/skills/<skill>/SKILL.md`

The gateway config always includes `skills.load.extraDirs = ["<workspace>/skills"]`, so
skills in that folder are discoverable without extra per‑gateway config.

## Gateway ports

Gateway ports are auto-assigned from `hosts.<host>.gatewaysOrder`, which keeps port allocation
deterministic across deploys.

Per‑gateway override (example):

```bash
clawlets config set --path hosts.<host>.gateways.melinda.profile.gatewayPort --value 18819
```

## Model defaults (provider/model)

Set a default model for the host, then override per gateway if needed:

```bash
clawlets host set --agent-model-primary zai/glm-4.7
```

Per‑gateway override:

```bash
clawlets config set --path hosts.<host>.gateways.melinda.agents.defaults.model.primary --value zai/glm-4.7
clawlets config set --path hosts.<host>.gateways.melinda.agents.defaults.model.fallbacks --value-json '["anthropic/claude-opus-4-5"]'
```

Provider API keys are wired via sops secret names:

```bash
clawlets config set --path fleet.secretEnv.ZAI_API_KEY --value z_ai_api_key
clawlets config set --path fleet.secretEnv.ANTHROPIC_API_KEY --value anthropic_api_key
clawlets config set --path fleet.secretEnv.OPENAI_API_KEY --value openai_api_key
```

These are injected into per‑gateway `EnvironmentFile=` entries via sops‑nix templates.

## Codex CLI (server)

If you need the Codex CLI to run on a host, enable it per gateway and allow the bundled
skill that provides the integration:

```bash
clawlets fleet set --codex-enable true
```

Then allow bundled `coding-agent` for those gateways:

```bash
clawlets config set --path hosts.<host>.gateways.gunnar.skills.allowBundled --value-json '["github","coding-agent"]'
clawlets config set --path hosts.<host>.gateways.maren.skills.allowBundled --value-json '["github","brave-search","coding-agent"]'
```

One‑time login (headless):

```bash
sudo -u gateway-maren env HOME=/srv/openclaw/maren codex login --device-auth
sudo -u gateway-gunnar env HOME=/srv/openclaw/gunnar codex login --device-auth
```

## Bonjour / mDNS (optional)

If mDNS errors appear on your host, disable Bonjour explicitly:

```nix
services.openclawFleet.disableBonjour = true;
```

## GitHub inventory sync (optional)

Run GitHub inventory sync on-demand:

```bash
clawlets server github-sync status --target-host admin@<host>
clawlets server github-sync run --target-host admin@<host> --gateway <gatewayId>
```

Requires at least one gateway with GitHub App config (`hosts.<host>.gateways.<gatewayId>.profile.github.*`).

## Ops snapshots (optional)

Host ops snapshots (no secrets) are opt‑in (`services.openclawFleet.opsSnapshot.enable = true`).

## Per‑gateway profiles (canonical config)

Each gateway can have different profile settings, including:

- bundled skill allowlist
- per‑skill env + secrets
- hook config + secrets
- GitHub App auth config (for non‑interactive `gh` + git pushes)
