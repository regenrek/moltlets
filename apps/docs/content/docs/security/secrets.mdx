---
title: Secrets
description: Sops/age secret handling.
---

Secrets handling is one of the places where infrastructure projects usually go wrong:
tokens land in Git, secrets end up in build artifacts, or “temporary” files become
permanent.

Clawlets uses sops + age for secrets so values can live in the project repo as encrypted
YAML, and only become plaintext on the host at runtime.

<Callout type="info" title="What this page is trying to give you">
The mental model of where secrets live, which keys exist, and which commands move
secrets from repo → server without placing them in the Nix store.
</Callout>

## Why this design

This approach is intended to reduce common risks:

- secrets can be committed safely (encrypted) instead of copied around manually,
- the Nix store is treated as non-secret (secrets are injected at runtime),
- and updates can refuse to apply if the host’s installed secrets don’t match the
  release’s expected digest (see [Updates](/security/updates)).

## Mental model

Think of secrets as “encrypted at rest everywhere”, with one controlled decrypt point
on the server.

<Mermaid
  chart={`graph TD
  Operator["Operator machine"] --> Repo["Git repo: secrets/ (SOPS encrypted)"]
  Repo --> Publisher["Publisher (CI or Linux builder)"]
  Publisher --> BaseUrl["Release base URL (baseUrls)"]
  BaseUrl --> Updater["Host updater (root)"]
  Updater --> Runtime["Runtime: /run/secrets (decrypted by sops-nix)"]
`}
/>

## Files and directories

These are the canonical locations for secrets and keys:

- `secrets/.sops.yaml` (recipients + rules; committed)
- `secrets/hosts/<host>/` (encrypted secrets payload; committed)
- `secrets/keys/hosts/<host>.agekey.yaml` (encrypted host age key; committed)
- `<runtimeDir>/keys/operators/hosts/<host>/<operator>.agekey` (host-scoped operator private key; local only)

## Scope: fleet vs gateway

All secret values live under `secrets/hosts/<host>/...`. Scope is about wiring, not storage.

- fleet scope: `fleet.secretEnv` and `fleet.secretFiles` (shared by all gateways)
- gateway scope: `hosts.<host>.gateways.<gatewayId>.profile.secretEnv` and `hosts.<host>.gateways.<gatewayId>.profile.secretFiles`

Secret file targets:

- `fleet.secretFiles.*.targetPath` must be under `/var/lib/clawlets/`
- `hosts.<host>.gateways.<gatewayId>.profile.secretFiles.*.targetPath` must be under `/var/lib/clawlets/secrets/gateways/<gatewayId>/`

## `${ENV}` wiring + autowire

Clawlets detects `${ENV_VAR}` refs inside `hosts.<host>.gateways.<gatewayId>.openclaw`, plus known channel tokens,
hooks, skills, and provider `apiKey` fields. These references form the allowlist of secret names.

Rules:

- use uppercase env vars (`${ENV_VAR}` only)
- escape literal `${ENV_VAR}` as `$${ENV_VAR}`
- avoid inline tokens; use `${ENV_VAR}` + secret mappings

Missing mappings:

- CLI: `clawlets config wire-secrets --write` or `clawlets secrets init --autowire`
- UI: Host secrets panel Missing secret wiring; Gateway integrations panel Secret wiring

For dashboard deploy credential handling and browser-to-runner submit flow, see
[Deploy credentials](/dashboard/deploy-credentials).

## Day 0: Authoring + bootstrap

You author secrets in the repo (encrypted), and you bootstrap the host once.

```bash
clawlets secrets init
```

This generates:

- host-scoped operator age keypair in `<runtimeDir>/keys/operators/hosts/<host>/`
- encrypted host age key at `secrets/keys/hosts/<host>.agekey.yaml`
- `secrets/.sops.yaml` rules for host secrets + host key file
- encrypted `secrets/hosts/<host>/*.yaml`
- `<runtimeDir>/extra-files/<host>/...` (host key + encrypted host secrets) for first install

Verify locally:

```bash
clawlets secrets verify
```

## Day N (default): Published secrets bundle + host pull

For normal fleet updates, prefer publishing a secrets bundle alongside your signed
release manifest. The manifest pins the **sha256 digest** of the encrypted bundle.

On the host, the updater:

- checks the installed secrets digest
- if it does not match and `secrets.url` is set, downloads the encrypted bundle
- verifies the bundle digest matches the manifest
- installs it into `/var/lib/clawlets/secrets/hosts/<host>/` (still encrypted)
- proceeds to switch the system (or fails with a clear error if secrets are missing)

This keeps Day N changes “publisher → host pull”, without requiring operators to push
secrets over SSH.

See [Deploy](/operations/deploy) for the CI publish workflow and example commands.

## Recovery: Push secrets over SSH (optional)

`clawlets secrets sync` exists as a manual fallback: it packages the encrypted secrets
and installs them on the host via `install-secrets` over SSH.

Use it when you need to repair a host quickly, not as the default Day N workflow.

```bash
clawlets secrets sync --host <host>
```

<Callout type="warning" title="Requires host permission">
If you run this as `admin@...`, the host must allow `install-secrets` (see
`operator.deploy.enable` and [Ops invariants](/security/ops-invariants)).
</Callout>

## Manual edits

For manual edits, make sure your operator key is loaded and use `sops edit`:

```bash
SOPS_AGE_KEY_FILE=<runtimeDir>/keys/operators/hosts/<host>/<you>.agekey \
  sops edit secrets/hosts/<host>/admin_password_hash.yaml
```

## Troubleshooting

Most errors are either a missing `.sops.yaml` rule or a missing private key.

If you see:

```text
error loading config: no matching creation rules found
```

Your `secrets/.sops.yaml` rule did not match the file path you are encrypting.
Fast fix: re-run `clawlets secrets init` (regenerates `.sops.yaml`).

If you see:

```text
Failed to get the data key required to decrypt the SOPS file.
... no identity matched any of the recipients ...
```

Your age identity cannot decrypt the file (wrong key or recipients).
Fast fix:

```bash
clawlets secrets init --yes
```

If the host updater fails with a **secrets digest mismatch**, it means the release
expects a different encrypted secrets bundle than what is installed on the host.

- preferred fix: publish the secrets bundle referenced by the manifest (`secrets.url`)
  and let the host pull it during update
- recovery fix: push secrets with `clawlets secrets sync`, then retry the update

## Common keys

These are common secret keys and where they are used. The exact names are yours to
choose, as long as the mappings in `fleet/clawlets.json` match.

- `tailscale_auth_key` (required when using Tailscale auto‑join)
- `garnix_netrc` (netrc for authenticated cache access; installed at `/etc/nix/netrc` when `hosts.<host>.cache.netrc.enable = true`)
- `discord_token_<gatewayId>` (default mapping via `hosts.<host>.gateways.<gatewayId>.profile.secretEnv.DISCORD_BOT_TOKEN`)
- LLM API keys wired via env vars referenced in OpenClaw config, then mapped in `fleet.secretEnv` or per‑gateway overrides
- hook tokens mapped to `OPENCLAW_HOOKS_TOKEN` and `OPENCLAW_HOOKS_GMAIL_PUSH_TOKEN`
- skill keys mapped to `OPENCLAW_SKILL_<SKILL>_API_KEY`

Secrets are injected by sops‑nix at activation time:

- per‑gateway env vars via `sops.templates` → `EnvironmentFile=...`
- optional secret files via `sops.secrets` with explicit `path=...`

Related: [Tailscale auth key setup](/dashboard/tailscale-auth-key)
