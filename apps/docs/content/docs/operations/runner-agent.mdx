---
title: Runner Agent
description: Pair, start, and operate runner agents.
---

Runner agents execute jobs for a project and report metadata back to the control plane.

## Control-plane freshness model

Dashboard setup checks for a **fresh** runner heartbeat. Current freshness window is
about 30 seconds. If no heartbeat lands in that window, the runner is treated as
offline for setup gating.

Repo readiness in setup/header UI is metadata-based:

- `Repo: Reachable` means runner metadata sync has a fresh `fleet` config entry with no `lastError`.
- UI does not enqueue a `config show` runner job just to render readiness badges.

## Pairing

Create a runner token from the dashboard/admin surface, then start the runner:

```bash
clawlets runner start \
  --project <projectId> \
  --token <runner-token> \
  --control-plane-url <https://dashboard-host>
```

Optional flags:

- `--name <runner-name>`
- `--repoRoot <repo-path>`
- `--log-level <fatal|error|warn|info|debug|trace>` (env: `CLAWLETS_LOG_LEVEL`)
- `--log-file <path>` (env: `CLAWLETS_LOG_FILE`)
- `--no-log-file`
- `--pollMs <interval>`
- `--pollMaxMs <max-interval>`
- `--leaseWaitMs <idle-long-poll-window>`
- `--leaseTtlMs <ttl>`
- `--heartbeatMs <ttl>`
- `--maxAttempts <n>`

Current defaults:

- `pollMs=4000`
- `pollMaxMs=8000`
- `leaseWaitMs=0`
- `heartbeatMs=30000`
- `leaseTtlMs=30000`

## Heartbeats and capabilities

Runner sends:

- runner heartbeat (`/runner/heartbeat`)
- job lease heartbeat (`/runner/jobs/heartbeat`)

If heartbeat goes stale, jobs become lease-eligible again after TTL expiry.

Runner heartbeat capabilities include:

- `supportsInfraApply`
- `supportsSealedInput`
- `sealedInputAlg`
- `sealedInputPubSpkiB64`
- `sealedInputKeyId`
- `hasNix`
- `nixVersion`
- `nixBin`

Current sealed-input algorithm: `rsa-oaep-3072/aes-256-gcm`.

## Secrets handling

Default secure path:

- Browser encrypts secret payload for one selected target runner and sends ciphertext only to control plane.
- Jobs are reserved first (`sealed_pending`) and become leasable only after ciphertext finalize.
- Runner decrypts sealed payload locally and executes command non-interactively.
- Placeholder jobs fail fast when sealed input is missing/invalid.

Control plane never stores plaintext secret values.

Operator walkthrough for this flow: [Deploy credentials](/dashboard/deploy-credentials).

## Metadata sync limits

`/runner/metadata/sync` enforces bounded payload sizes:

- `projectConfigs <= 500`
- `hosts <= 200`
- `gateways <= 500`
- `secretWiring <= 2000`
- per-host `secretWiring <= 500` (extra rows dropped)

Oversized payloads are rejected (`400`).

## Error taxonomy and stop/retry policy

Runner HTTP errors are classified as:

- `auth`: `401`/`403`
- `permanent`: non-`429` `4xx`
- `transient`: `429`, `5xx`, network errors, request timeouts
- `malformed`: invalid JSON response

Runner behavior:

- Lease loop: `auth`/`permanent` stop; `transient`/`malformed`/`unknown` retry with backoff.
- Lease responses can include `waitApplied` so runner skips duplicate local sleep when control-plane long-poll already waited.
- Job completion call: `auth`/`permanent` stop; `transient`/`malformed`/`unknown` continue.
- Heartbeat, metadata sync, and run-event append failures are logged and non-fatal.

## Filesystem boundary

Runner-local only:

- Git working tree
- `.clawlets/` runtime state
- SOPS keys/material
- SSH credentials

Control plane should not mount or require repo-root paths.

## Troubleshooting

- **Runner offline:** verify process is running and token is not revoked.
- **No runner logs:** default file is `<repoRoot>/.clawlets/logs/runner/<projectId>-<runnerName>.jsonl` (JSONL; owner-only perms).
- **Jobs stuck queued:** check runner project id, token scope, and lease endpoints reachability.
- **Lease expired mid-run:** ensure heartbeat interval is below lease TTL.
- **Runner flips offline in setup:** check heartbeat cadence and runner process health (freshness window is ~30s).
- **No sealed-capable runner available:** upgrade runner and confirm heartbeat includes `supportsSealedInput`, `sealedInputPubSpkiB64`, and `sealedInputKeyId`.
- **Sealed submit requires runner selection:** if multiple sealed-capable runners are online, pick one target runner before saving deploy credentials.
- **Metadata sync rejected (`400`):** reduce payload array sizes to documented limits.
- **Repeated failures:** inspect run logs (`runs` + `runEvents`) and adjust command args/config.
