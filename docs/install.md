# Install (Hetzner + nixos-anywhere + OpenTofu)

## Install clawdlets (CLI)

If you’re using clawdlets as intended (CLI-first; no need to clone this repo):

```bash
npm install -g clawdlets
clawdlets --help
```

## Inputs

- `infra/configs/clawdlets.json` (canonical config: bots, guildId, host settings)
- `infra/configs/fleet.nix` (derived fleet config; reads `clawdlets.json`; don’t edit)
- `secrets/` (committed; sops-encrypted secrets + sops rules)
- `.clawdlets/` (gitignored runtime: operator keys + nixos-anywhere extra-files)
- `infra/disko/example.nix` (disk layout; device via `clawdlets.diskDevice`)
- `infra/documents/*` (AGENTS/SOUL/TOOLS/IDENTITY seeded into workspaces)
- `infra/opentofu/terraform.tfstate` (gitignored; keep single-operator policy)

## Hetzner Cloud specifics (non-negotiable)

- Firmware: legacy BIOS (SeaBIOS) → GRUB (i386-pc) + GPT `EF02` BIOS boot partition (no EFI/systemd-boot).
- Networking: DHCP via `systemd-networkd` (Hetzner hands out `/32` + gateway `172.31.1.1`).
- Initrd: must include virtio modules or the VM won’t boot (`virtio_*` in `boot.initrd.availableKernelModules`).

## Deterministic dev env (recommended)

If you use `devenv` (devenv.sh), this repo includes `devenv.nix` to provide a consistent toolchain
(`pnpm`, `sops`, `age`, `jq`, `gh`, etc).

From repo root:

```bash
devenv shell
```

## Tooling bundle (optional)

Default install uses `clawdbot-gateway` only (small, reliable bootstrap).

If you want the additional tools in PATH (e.g. `summarize`, `oracle`, etc), enable:

```nix
services.clawdbotFleet.tools.enable = true;
```

## 0) Prefill checklist

- `infra/configs/clawdlets.json`
  - `fleet.guildId`
  - `fleet.bots`
  - `hosts.<host>.sshAuthorizedKeys`
  - `hosts.<host>.diskDevice`
  - `hosts.<host>.tailnet`
  - `hosts.<host>.enable = true` (disabled by default in the public template)
- `secrets/.sops.yaml`
  - creation rules + recipients for `secrets/hosts/clawdbot-fleet-host/*.yaml` (generated by `clawdlets secrets init`)
- `secrets/hosts/clawdbot-fleet-host/`
  - `tailscale_auth_key.yaml` (required when `hosts.<host>.tailnet.mode = "tailscale"`)
  - `admin_password_hash.yaml` (required; for `sudo` on admin user)
  - `discord_token_<bot>.yaml`
  - optional: skill secrets / hook tokens / GitHub App key / restic secrets
  - optional: `root_password_hash` (console-only; keep root SSH disabled; requires `enableRootPassword = true`)
- `.clawdlets/extra-files/clawdbot-fleet-host/var/lib/sops-nix/key.txt`
  - host age key installed to `/var/lib/sops-nix/key.txt` during nixos-anywhere
- `infra/disko/example.nix`
  - set `clawdlets.diskDevice` (see below)

## Disk device (required)

`infra/disko/example.nix` uses `config.clawdlets.diskDevice`. Before the first install, set it in `infra/configs/clawdlets.json` (or via `clawdlets host set --disk-device ...`):

```nix
({ ... }: {
  clawdlets.hostName = "clawdbot-fleet-host";
})
```

## Getting required values

### Hetzner API token (HCLOUD_TOKEN)

Create a token in the Hetzner Cloud Console:

- https://console.hetzner.cloud/ → Security → API Tokens

### Admin CIDR (ADMIN_CIDR)

Your public IPv4 CIDR allowed to SSH during bootstrap (typically `<your-ip>/32`).

Example helper:

```bash
curl -4 https://ifconfig.me
```

Then append `/32`.

### GitHub token (GITHUB_TOKEN) (only for private flake repos)

Only needed if `base.flake` points to a private GitHub repo (so the server can fetch it).

Create a fine-grained personal access token:

- https://github.com/settings/personal-access-tokens/new

Recommended settings:

- Repository access: Only select repositories → select your infra repo
- Repository permissions: Contents → Read-only

## Admin password (required)

Goal: after every reinstall, `admin` can log in on console and can run the allowlisted `sudo` commands needed for ops, while SSH stays key-only.

1) Generate a yescrypt hash locally (no cleartext in git):

```bash
nix shell nixpkgs#mkpasswd -c mkpasswd -m yescrypt
```

2) Store the hash in sops:

```bash
SOPS_AGE_KEY_FILE=.clawdlets/keys/operators/<you>.agekey EDITOR=vim sops edit secrets/hosts/clawdbot-fleet-host/admin_password_hash.yaml
```

Set:

- `admin_password_hash: '$y$j9T$...'`

Optional:

None. Root password is intentionally disabled (console recovery uses `breakglass`).

Note: the hash contains `$...`; if you ever paste it into a shell, use single quotes (zsh may treat `$y` as a variable).

To rotate later: update the sops value + redeploy (don’t run `passwd` on-host; `users.mutableUsers = false`).

## 1) Provision + install

```bash
clawdlets env init
clawdlets secrets init
clawdlets doctor --scope deploy
clawdlets bootstrap
```

Before running live actions, set deploy creds:

- Recommended: edit `.clawdlets/env` (created by `clawdlets env init`)
  - `HCLOUD_TOKEN` (required for provisioning)
  - `GITHUB_TOKEN` (optional; only if `baseFlake` points at a private GitHub repo)
- Alternative: set normal environment variables (CI-friendly)

Local dev note (working inside this monorepo): install a local wrapper into `~/bin`:

```bash
just clawdlets-dev-install
clawdlets --help
```

Note: clawdlets uses OpenTofu (`nixpkgs#opentofu`) for Hetzner provisioning.

Hetzner SSH key: bootstrap ensures the SSH key exists in your Hetzner account and reuses
it across re-provisions (no "SSH key not unique" failures).

Bootstrap installs with `--build-on-remote` and uses your `origin` on GitHub as the
flake source by default (so the remote builds from source and doesn't need unsigned
local store paths). You can override:

```bash
clawdlets bootstrap --flake github:<owner>/<repo>
```

If the flake repo is private, set `GITHUB_TOKEN` in your environment (fine-grained PAT scoped to
this repo; Contents: read-only) so the remote can fetch the flake. Public flake repos
need no token.

## 2) Rebuild (pinned)

Use a pinned commit for rebuilds. Short revs are fine; the CLI resolves them to a full SHA.

```bash
just server-rebuild-rev admin@<ipv4> HEAD
# or:
clawdlets server rebuild --target-host admin@<ipv4> --rev HEAD
```

`--rev HEAD` is resolved locally before the remote build.

More deploy/update options (and tradeoffs): `docs/deploy.md`.

Note: GitHub flake fetches are cached by Nix. Bootstrap forces refresh (`tarball-ttl=0`) so new commits
are picked up immediately during iteration.

Note: Even if the upstream flakes declare garnix cache settings in `nixConfig`, Nix may ignore them unless
`accept-flake-config = true`. Bootstrap passes `accept-flake-config=true` and adds the garnix substituter +
public key explicitly to avoid “build from source” surprises during install.

## Server type (Hetzner)

Default is `cx43` (16GB RAM). Reason: bootstrap builds run on the remote and can OOM on small machines
when Node/pnpm-heavy packages are in the closure.

This repo installs `x86_64-linux` NixOS. Use Intel/AMD types (`CX*`, `CPX*`, `CCX*`), not ARM (`CAX*`),
unless you also change the flake system to `aarch64-linux`.

Reference:

- Server types/pricing: https://www.hetzner.com/de/cloud/

## macOS (Determinate Nix): fix “restricted setting / not a trusted user”

If bootstrap fails with warnings like:
- `ignoring the client-specified setting 'require-sigs' ... restricted setting ... not a trusted user`

Then your local `nix-daemon` is refusing restricted settings. Fix once:

1) Edit `nix.custom.conf` (Determinate-managed `nix.conf` is replaced):

```bash
sudo vim /etc/nix/nix.custom.conf
```

Add one:
- `trusted-users = root <your-mac-username>` (tight)
- `trusted-users = root @admin` (all macOS admins)

2) Restart `nix-daemon`:

```bash
sudo launchctl kickstart -k system/org.nixos.nix-daemon
```

If that label doesn’t exist (Determinate often uses a different launchd label), find it then kickstart it:

```bash
sudo launchctl print system | rg -i 'nix-daemon|determinate'
```

Fallback (works even if you can’t find the label): kill the daemon PID and let launchd restart it:

```bash
ps -axo pid,command | rg 'nix-daemon'
sudo kill <pid>
```

With `just`: `just nix-daemon-restart`

3) Verify:

```bash
nix config show | rg -n 'trusted-users'
```

## Troubleshooting: OOM during remote build (exit 137)

If bootstrap fails with `exit code 137` / `Killed` while building `*-pnpm-deps.drv`, the remote builder
ran out of RAM (OOM killer).

Fix (pick one):

- Reduce closure size: don’t enable `"coding-agent"` / Codex during bootstrap (it pulls in heavy Node deps).
  Example: `clawdlets config set --path fleet.botOverrides.maren.skills.allowBundled --value-json '["github","brave-search"]'`
- Use a bigger Hetzner server type for bootstrap (`clawdlets host set --server-type ...`).
- Add swap on the target (best long-term anyway). If you want swap during install/bootstrap, add a swap
  partition in `infra/disko/example.nix` (so it’s available in the installer environment too).

If you have `just` installed:

```bash
just install
just doctor
just bootstrap
just tofu-lockdown
```

OpenTofu is modularized. Add a second host by instantiating another `bot_host`
module in `infra/opentofu/main.tf`.

## Troubleshooting: SSH host key changed after reinstall

Symptoms:

- `WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!`
- ssh fails even though port 22 is open

Fix:

```bash
ssh-keygen -R <ipv4>
ssh-keygen -R '[<ipv4>]:22' || true
ssh admin@<ipv4>
```

Note: `clawdlets bootstrap` clears these entries automatically after install.

## 2) Lock down to VPN-only

After tailnet (Tailscale) works:

1) Disable bootstrap SSH in canonical config:

```bash
clawdlets host set --public-ssh false
```

2) Remove public SSH rule from Hetzner firewall:

```bash
clawdlets infra apply --public-ssh=false
```

Optional: one-shot helper (rebuild over SSH + opentofu apply):

```bash
clawdlets lockdown --target-host admin@10.44.0.1
```

## Optional: Tailscale (recommended)

This repo enables Tailscale on the host (for reliable admin access even if
WireGuard client setup is inconvenient).

On the server (once):

```bash
sudo tailscale up
```

Then SSH over tailnet:

```bash
ssh admin@<tailscale-ip-of-clawdbot-fleet-host>
```
