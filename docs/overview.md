# Overview

Project repo (created by `clawlets project init` from `clawlets-template`) =
**public-safe infra + fleet config + encrypted secrets**.
This repo (clawlets) = CLI + infra framework + docs.

## What lives where

**Project repo (in git)**
- `flake.nix` / `flake.lock`: NixOS build graph (imports the clawlets framework; no per-project infra code)
- `fleet/`: bot roster + routing/skills + workspace docs (app layer)
- `fleet/clawlets.json`: canonical fleet/host config
- `secrets/`: sops-encrypted secrets (safe to commit)
- `cattle/personas/`: cattle persona registry (SOUL/config/skills/memory)
- `agent-playbooks/`: “how to run” playbooks for bots/operators

Notes
- The project template does **not** ship a `docs/` copy; docs live in this CLI repo.

**CLI repo (in git)**
- `packages/cli/`: `clawlets` (single entrypoint)
- `packages/clf/`: `clf` family (queue + orchestrator + bot-facing CLI)
- `packages/core/`: shared logic (CLI + checks)
- `docs/`: canonical docs (single source of truth)

**Not in git (project repo `.clawlets/`, runtime)**
- `keys/operators/*.agekey`: local operator private keys (never commit)
- `extra-files/<host>/...`: `nixos-anywhere --extra-files` payload (generated by `clawlets secrets init`)
- `images/<host>/...`: raw image outputs (optional; image-based bootstrap)
- `.clawlets/infra/opentofu/<host>/...`: provisioning state (gitignored)

## Pet vs Cattle

- Pet: long-running Hetzner hosts, run the Discord fleet.
- Cattle: ephemeral Hetzner VMs for one task (TTL; spawn → run → destroy).

See `docs/cattle.md` for cattle lifecycle + commands.
See `docs/orchestrator.md` for `clf` (bot-facing jobs queue + cattle spawner).

## Deployment lifecycle (Hetzner)

0) (optional) scaffold a fresh project repo:
```bash
export CLAWLETS_INTERACTIVE=1
clawlets project init --dir ./clawlets-myproject
cd ./clawlets-myproject
```

Note: `project init` already includes `fleet/clawlets.json`. Don’t run `clawlets config init` unless you want to reset it (`--force`).

1) **Configure canonical config (bots/host)**

```bash
clawlets fleet set --guild-id <id>
clawlets bot add --bot <id>
clawlets host set --add-ssh-key-file ~/.ssh/id_ed25519.pub
clawlets host set --disk-device /dev/sda
clawlets host set --enable true
clawlets host set --ssh-exposure bootstrap
```

2) **Create secrets (sops/age)**
```bash
clawlets secrets init
```

3) **Sanity checks**
```bash
clawlets doctor --scope bootstrap
```

4) **Provision + install (provisioning + nixos-anywhere)**
```bash
clawlets bootstrap
```

Optional image-based bootstrap:
```bash
clawlets image build --host <host>
clawlets image upload --host <host> --image-url https://<bucket>/<image>.raw --compression bz2
clawlets bootstrap --mode image
```

5) **Deploy + lock down (after tailnet works)**
```bash
clawlets host set --target-host admin@<tailscale-ip>
clawlets host set --ssh-exposure tailnet
clawlets server update apply --host <host>
clawlets lockdown
```

6) **Operate**
- status: `clawlets server status`
- logs: `clawlets server logs --unit clawdbot-melinda.service --follow`
- apply updates: `clawlets server update apply --host <host>`

## Secrets model (important)

- Host secrets file lives on the **host filesystem**:
  - `/var/lib/clawlets/secrets/hosts/<host>/<secret>.yaml`
- `sops-nix` reads it from that path (so secrets don’t end up in `/nix/store`).
- `nixos-anywhere` injects on first install via `.clawlets/extra-files/<host>/...`.

See `docs/secrets.md` and `docs/security.md`.
