# Overview

Project repo (created by `clawdlets project init` from `clawdlets-template`) =
**public-safe infra + fleet config + encrypted secrets**.
This repo (clawdlets) = CLI + infra framework + docs.

## What lives where

**Project repo (in git)**
- `flake.nix` / `flake.lock`: NixOS build graph (imports the clawdlets framework; no per-project infra code)
- `fleet/`: bot roster + routing/skills + workspace docs (app layer)
- `fleet/clawdlets.json`: canonical fleet/host config
- `secrets/`: sops-encrypted secrets (safe to commit)
- `cattle/personas/`: cattle persona registry (SOUL/config/skills/memory)
- `agent-playbooks/`: “how to run” playbooks for bots/operators

Notes
- The project template does **not** ship a `docs/` copy; docs live in this CLI repo.

**CLI repo (in git)**
- `packages/cli/`: `clawdlets` (single entrypoint)
- `packages/clf/`: `clf` family (queue + orchestrator + bot-facing CLI)
- `packages/core/`: shared logic (CLI + checks)
- `docs/`: canonical docs (single source of truth)

**Not in git (project repo `.clawdlets/`, runtime)**
- `keys/operators/*.agekey`: local operator private keys (never commit)
- `extra-files/<host>/...`: `nixos-anywhere --extra-files` payload (generated by `clawdlets secrets init`)
- `images/<host>/...`: raw image outputs (optional; image-based bootstrap)
- `.clawdlets/infra/opentofu/<host>/...`: provisioning state (gitignored)

## Pet vs Cattle

- Pet: long-running Hetzner hosts, run the Discord fleet.
- Cattle: ephemeral Hetzner VMs for one task (TTL; spawn → run → destroy).

See `docs/cattle.md` for cattle lifecycle + commands.
See `docs/orchestrator.md` for `clf` (bot-facing jobs queue + cattle spawner).

## Deployment lifecycle (Hetzner)

0) (optional) scaffold a fresh project repo:
```bash
export CLAWDLETS_INTERACTIVE=1
clawdlets project init --dir ./clawdlets-myproject
cd ./clawdlets-myproject
```

Note: `project init` already includes `fleet/clawdlets.json`. Don’t run `clawdlets config init` unless you want to reset it (`--force`).

1) **Configure canonical config (bots/host)**

```bash
clawdlets fleet set --guild-id <id>
clawdlets bot add --bot <id>
clawdlets host set --add-ssh-key-file ~/.ssh/id_ed25519.pub
clawdlets host set --disk-device /dev/sda
clawdlets host set --enable true
clawdlets host set --ssh-exposure bootstrap
```

2) **Create secrets (sops/age)**
```bash
clawdlets secrets init
```

3) **Sanity checks**
```bash
clawdlets doctor --scope bootstrap
```

4) **Provision + install (provisioning + nixos-anywhere)**
```bash
clawdlets bootstrap
```

Optional image-based bootstrap:
```bash
clawdlets image build --host <host>
clawdlets image upload --host <host> --image-url https://<bucket>/<image>.raw --compression bz2
clawdlets bootstrap --mode image
```

5) **Deploy + lock down (after tailnet works)**
```bash
clawdlets host set --target-host admin@<tailscale-ip>
clawdlets host set --ssh-exposure tailnet
clawdlets server deploy --manifest deploy-manifest.<host>.json
clawdlets lockdown
```

6) **Operate**
- status: `clawdlets server status`
- logs: `clawdlets server logs --unit clawdbot-melinda.service --follow`
- deploy pinned: `clawdlets server deploy --manifest deploy-manifest.<host>.json`

## Secrets model (important)

- Host secrets file lives on the **host filesystem**:
  - `/var/lib/clawdlets/secrets/hosts/<host>/<secret>.yaml`
- `sops-nix` reads it from that path (so secrets don’t end up in `/nix/store`).
- `nixos-anywhere` injects on first install via `.clawdlets/extra-files/<host>/...`.

See `docs/secrets.md` and `docs/security.md`.
