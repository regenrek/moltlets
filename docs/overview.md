# Overview

This repo = **public-safe infra + fleet config + encrypted secrets**.

## What lives where

**In git**
- `infra/`: NixOS + OpenTofu + fleet module
- `fleet/`: bot roster + routing/skills + workspace docs (app layer)
- `fleet/clawdlets.json`: canonical fleet/host config
- `secrets/`: sops-encrypted secrets (safe to commit)
- `docs/`: operating manual
- `cli/`: `clawdlets` (single entrypoint)
- `packages/core/`: shared logic (CLI + future UI)

**Not in git (`.clawdlets/`, runtime)**
- `keys/operators/*.agekey`: local operator private keys (never commit)
- `extra-files/<host>/...`: `nixos-anywhere --extra-files` payload (generated by `clawdlets secrets init`)

## Deployment lifecycle (Hetzner)

0) (optional) scaffold a fresh project repo:
```bash
export CLAWDLETS_INTERACTIVE=1
clawdlets project init --dir ./clawdlets-myproject
cd ./clawdlets-myproject
```

Note: `project init` already includes `fleet/clawdlets.json`. Don’t run `clawdlets config init` unless you want to reset it (`--force`).

1) **Configure canonical config (bots/host)**

```bash
clawdlets fleet set --guild-id <id>
clawdlets bot add --bot <id>
clawdlets host set --add-ssh-key-file ~/.ssh/id_ed25519.pub
clawdlets host set --disk-device /dev/disk/by-id/...
clawdlets host set --enable true
```

2) **Create secrets (sops/age)**
```bash
clawdlets secrets init
```

3) **Sanity checks**
```bash
clawdlets doctor --scope deploy
```

4) **Provision + install (OpenTofu + nixos-anywhere)**
```bash
clawdlets bootstrap
```

5) **Lock down (after tailnet works)**
```bash
clawdlets host set --target-host admin@<tailscale-ip>
clawdlets lockdown
```

6) **Operate**
- status: `clawdlets server status`
- logs: `clawdlets server logs --unit clawdbot-melinda.service --follow`
- rebuild pinned: `just server-rebuild-rev <host> HEAD`

## Secrets model (important)

- Host secrets file lives on the **host filesystem**:
  - `/var/lib/clawdlets/secrets/hosts/<host>/<secret>.yaml`
- `sops-nix` reads it from that path (so secrets don’t end up in `/nix/store`).
- `nixos-anywhere` injects on first install via `.clawdlets/extra-files/<host>/...`.

See `docs/secrets.md` and `docs/security.md`.
