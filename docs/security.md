# Security model

## Goals

- No tokens/keys committed to git.
- No secrets copied into `/nix/store`.
- SSH stays key-only; passwords for `sudo`/console only.
- Public SSH is temporary (bootstrap only; controlled by `sshExposure.mode`).

## Boundaries

**Public-safe repo**
- `flake.nix` / `flake.lock` (build graph; imports the clawdlets framework)
- `fleet/clawdlets.json` (no secrets)
- `secrets/` (sops-encrypted; safe to commit)

**Local runtime dir (gitignored)**
- `.clawdlets/keys/operators/*.agekey`: operator private keys (never commit)
- `.clawdlets/extra-files/<host>/...`: install payload generated by `clawdlets secrets init`
- `.clawdlets/infra/opentofu/<host>/...`: provisioning state (gitignored)

**On-server**
- `/var/lib/sops-nix/key.txt`: host age key
- `/var/lib/clawdlets/secrets/hosts/<host>/`: encrypted secrets files (sops)
- `/run/secrets/**`: decrypted materialized secrets at runtime (owned by service users)
- `/run/clf/orchestrator.sock`: bot-facing control-plane socket (group `clf-bots`)
- `/var/lib/clf/orchestrator/state.sqlite`: orchestrator DB (job payloads/results + token hashes; should be `0600`/`0700` scoped)

**Hetzner Cloud user_data (cattle)**
- Cattle uses cloud-init `user_data` to bootstrap:
  - `TAILSCALE_AUTH_KEY` (written to tmpfs) so the VM can join tailnet
  - one-time bootstrap token + baseUrl so the VM can fetch runtime env from `clf-orchestrator`
- Threat model MUST assume `user_data` can be read by anyone with Hetzner project/API access.
  - Treat `TAILSCALE_AUTH_KEY` as a **tailnet-join capability**: use tag-scoped + ephemeral keys, rotate regularly.
  - Keep bootstrap tokens short-lived + one-time (clamped to 30s..1h; default minutes).

## “Secrets out of store”

The Nix store is not a secrets vault. Design assumes store paths are widely readable on the host.

Therefore:
- secrets are read from `/var/lib/clawdlets/secrets/hosts/<host>/<secret>.yaml`
- `clawdlets secrets init` prepares those files for first install via `nixos-anywhere --extra-files`

## Recommended hardening checks

- Confirm Hetzner firewall no longer allows TCP/22 from the internet after lockdown.
- Confirm NixOS firewall only allows SSH via `tailscale0` when `sshExposure.mode=tailnet`.
- Confirm `clf-orchestrator` socket + state dir perms are tight (`/run/clf`, `/var/lib/clf/orchestrator`).
- Keep `.clawdlets/` gitignored (required).
- If `tailnet.mode=tailscale`, the Hetzner firewall allows inbound UDP/41641 for direct Tailscale connectivity. This is expected; disable Tailscale (tailnet.mode=none) or remove the rule if you need DERP-only.

## Egress policy (current)

Default is **anti-spam only**:

- It drops outbound TCP ports `{ 25, 465, 587, 2525 }` (SMTP variants).
- It does **not** restrict HTTPS/API egress, Discord, GitHub, model providers, etc.

## Egress policy (proxy allowlist, recommended)

Enable `clawdlets.egress.mode = "proxy-allowlist"` to:

- start a local HTTP proxy on loopback
- force bot services to talk only to localhost (systemd `IPAddressDeny=any` + allow loopback)
- require all outbound HTTP(S) to go through the proxy
- enforce a domain allowlist at the proxy layer

This is “real egress control” for bots without maintaining brittle IP allowlists.

## Supply chain (CI)

- GitHub Actions are pinned to commit SHAs (avoid tag drift).
- Dependabot opens weekly PRs for npm + GitHub Actions updates (`.github/dependabot.yml`).
- Updates are review-first (no auto-merge by default).
