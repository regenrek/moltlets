name: Bump flake inputs

on:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours (UTC)
  workflow_dispatch: {}

concurrency:
  group: bump-flake-inputs
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          fetch-depth: 0

      - name: Verify bump token configured
        env:
          BUMP_TEMPLATE_REF_TOKEN: ${{ secrets.BUMP_TEMPLATE_REF_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${BUMP_TEMPLATE_REF_TOKEN}" ]; then
            echo "error: missing required secret: BUMP_TEMPLATE_REF_TOKEN"
            echo "hint: create a fine-grained PAT with repo access + contents:read/write + pull requests:read/write"
            exit 1
          fi

      - name: Install Nix
        uses: cachix/install-nix-action@2126ae7fc54c9df00dd18f7f18754393182c73cd # v31.9.1
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Update flake inputs
        id: update
        run: |
          set -euo pipefail
          nix flake update \
            --update-input disko \
            --update-input sops-nix \
            --update-input nixos-generators \
            --update-input nix-openclaw
          if git diff --quiet flake.lock; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create PR
        id: cpr
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v4
        if: ${{ steps.update.outputs.changed == 'true' }}
        with:
          token: ${{ secrets.BUMP_TEMPLATE_REF_TOKEN }}
          branch: chore/bump-flake-inputs
          delete-branch: true
          add-paths: |
            flake.lock
          commit-message: "chore: bump flake inputs"
          title: "chore: bump flake inputs"
          body: |
            Automated update of flake.lock for core inputs.

      - name: Enable auto-merge
        if: ${{ steps.update.outputs.changed == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.BUMP_TEMPLATE_REF_TOKEN }}
        run: |
          set -euo pipefail
          gh pr merge "${{ steps.cpr.outputs.pull-request-number }}" --squash --auto --delete-branch
