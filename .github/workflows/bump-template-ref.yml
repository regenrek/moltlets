name: Bump template ref

on:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours (UTC)
  workflow_dispatch: {}

concurrency:
  group: bump-template-ref
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Verify bump token configured
        env:
          BUMP_TEMPLATE_REF_TOKEN: ${{ secrets.BUMP_TEMPLATE_REF_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${BUMP_TEMPLATE_REF_TOKEN}" ]; then
            echo "error: missing required secret: BUMP_TEMPLATE_REF_TOKEN"
            echo "hint: create a fine-grained PAT with repo access + contents:read/write + pull requests:read/write"
            exit 1
          fi

      - name: Resolve template refs
        id: template
        run: |
          set -euo pipefail
          repo="$(jq -r '.repo' config/template-source.json)"
          current_ref="$(jq -r '.ref' config/template-source.json)"
          if [ -z "$repo" ] || [ "$repo" = "null" ]; then
            echo "missing template repo in config/template-source.json"
            exit 1
          fi
          sha="$(git ls-remote "https://github.com/${repo}.git" HEAD | awk '{print $1}')"
          if [ -z "$sha" ]; then
            echo "failed to resolve template ref for ${repo}"
            exit 1
          fi
          echo "sha=$sha" >> "$GITHUB_OUTPUT"
          echo "current_ref=$current_ref" >> "$GITHUB_OUTPUT"
          if [ "$sha" = "$current_ref" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Update template ref
        if: ${{ steps.template.outputs.changed == 'true' }}
        run: |
          set -euo pipefail
          jq --arg ref "${{ steps.template.outputs.sha }}" '.ref=$ref' config/template-source.json \
            > config/template-source.json.tmp
          mv config/template-source.json.tmp config/template-source.json

      - name: Create PR
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v6
        if: ${{ steps.template.outputs.changed == 'true' }}
        with:
          token: ${{ secrets.BUMP_TEMPLATE_REF_TOKEN }}
          branch: chore/bump-template-ref
          delete-branch: true
          commit-message: "chore: bump template ref"
          title: "chore: bump template ref"
          body: |
            Automated update of config/template-source.json to latest clawdlets-template HEAD.
